{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register your school – Step {{ step }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'css/variables.css' %}" rel="stylesheet">
    <link href="{% static 'css/public-pages.css' %}" rel="stylesheet">
</head>

<body class="public-page">
    <div class="container container-narrow">
        <div class="card-public wide">
            <!-- Visual Step Progress Indicator -->
            <div class="step-progress">
                <div
                    class="step-item {% if step >= 1 %}{% if step == 1 %}active{% else %}completed{% endif %}{% endif %}">
                    <div class="step-circle">
                        {% if step|add:"0" > 1 %}<i class="fas fa-check"></i>{% else %}1{% endif %}
                    </div>
                    <span class="step-label">School</span>
                </div>
                <div
                    class="step-item {% if step >= 2 %}{% if step == 2 %}active{% elif step > 2 %}completed{% endif %}{% endif %}">
                    <div class="step-circle">
                        {% if step|add:"0" > 2 %}<i class="fas fa-check"></i>{% else %}2{% endif %}
                    </div>
                    <span class="step-label">Account</span>
                </div>
                <div class="step-item {% if step >= 3 %}active{% endif %}">
                    <div class="step-circle">3</div>
                    <span class="step-label">Review</span>
                </div>
            </div>

            <p class="step-badge-sm">Step {{ step }} of 3</p>
            <h1>
                {% if step == 1 %}School details
                {% elif step == 2 %}Owner account
                {% else %}Review & create
                {% endif %}
            </h1>
            {% if step == 1 %}<p class="guidance-text">Next you'll create the owner login for this school.</p>{% endif
            %}
            {% if step == 2 %}<p class="guidance-text">Next you'll review and create the school. You'll then log in with
                this account.</p>{% endif %}
            {% if step == 3 %}<p class="guidance-text">After this, you'll log in and add users from School Settings →
                Manage users.</p>{% endif %}

            {% if messages %}
            {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-error{% else %}alert-success{% endif %}">
                <i
                    class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %}"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
            {% endif %}

            {% if step == 1 %}
            <form method="post" action="?step=1">
                {% csrf_token %}
                <div class="form-group">
                    <label>School name *</label>
                    <div class="input-wrapper">
                        <input type="text" name="name" value="{{ data.name|default:'' }}"
                            placeholder="e.g. ABC Public School" required>
                        <i class="fas fa-school"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label>Address *</label>
                    <div class="input-wrapper">
                        <textarea name="address" rows="3" placeholder="Full address"
                            required>{{ data.address|default:'' }}</textarea>
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label>School code *</label>
                    <div class="input-wrapper">
                        <input type="text" name="school_code" value="{{ data.school_code|default:'' }}"
                            placeholder="e.g. ABC001" required>
                        <i class="fas fa-hashtag"></i>
                    </div>
                    <small>Unique identifier (letters/numbers)</small>
                </div>
                <div class="form-group">
                    <label>Subdomain code</label>
                    <div class="input-wrapper">
                        <input type="text" name="code" value="{{ data.code|default:'' }}"
                            placeholder="e.g. abc-school (optional)">
                        <i class="fas fa-link"></i>
                    </div>
                    <small>Lowercase, no spaces. Used for: code.yoursite.com</small>
                </div>
                <div class="mt-3 flex">
                    <button type="submit" class="btn-public btn-public-primary">Next – Owner account <i
                            class="fas fa-arrow-right"></i></button>
                </div>
            </form>
            {% endif %}

            {% if step == 2 %}
            <p><a href="?step=1" class="back-link">&larr; Back to school details</a></p>
            <form method="post" action="?step=2">
                {% csrf_token %}
                <div class="form-group">
                    <label>Username *</label>
                    <div class="input-wrapper">
                        <input type="text" name="owner_username" value="{{ data.owner_username|default:'' }}" required
                            autocomplete="username">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <div class="input-wrapper">
                        <input type="email" name="owner_email" value="{{ data.owner_email|default:'' }}"
                            placeholder="admin@school.com">
                        <i class="fas fa-envelope"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <div class="input-wrapper">
                        <input type="password" name="owner_password" id="password" required minlength="8"
                            autocomplete="new-password">
                        <i class="fas fa-lock"></i>
                    </div>
                    <div class="password-strength" id="passwordStrength">
                        <div class="password-strength-bar" id="passwordStrengthBar"></div>
                    </div>
                    <small class="password-hint" id="passwordHint">At least 8 characters</small>
                </div>
                <div class="form-group">
                    <label>Confirm password *</label>
                    <div class="input-wrapper">
                        <input type="password" name="owner_password2" required autocomplete="new-password">
                        <i class="fas fa-lock"></i>
                    </div>
                </div>
                <div class="mt-3 flex">
                    <button type="submit" class="btn-public btn-public-primary">Next – Review <i
                            class="fas fa-arrow-right"></i></button>
                    <a href="?step=1" class="btn-public btn-public-secondary">Back</a>
                </div>
            </form>
            {% endif %}

            {% if step == 3 %}
            <p><a href="?step=2" class="back-link">&larr; Back to owner account</a></p>

            <div class="review-section">
                <div class="review-row">
                    <span class="review-label">School name</span>
                    <span class="review-value">{{ data.name }}</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Address</span>
                    <span class="review-value">{{ data.address }}</span>
                </div>
                <div class="review-row">
                    <span class="review-label">School code</span>
                    <span class="review-value">{{ data.school_code }}</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Subdomain</span>
                    <span class="review-value">{{ data.code }}</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Owner</span>
                    <span class="review-value">{{ data.owner_username }} <span style="color: var(--text-muted);">({{
                            data.owner_email|default:"—" }})</span></span>
                </div>
            </div>

            <form method="post" action="?step=3" class="mt-3">
                {% csrf_token %}
                <div class="flex">
                    <button type="submit" class="btn-public btn-public-primary">Create school &amp; owner account <i
                            class="fas fa-rocket"></i></button>
                    <a href="?step=2" class="btn-public btn-public-secondary">Back</a>
                </div>
            </form>
            {% endif %}
        </div>
        <p style="text-align: center; margin-top: var(--space-6);">
            <a href="{% url 'landing' %}" class="back-link">Back to home</a> &middot;
            <a href="{% url 'login' %}" class="back-link">Already have an account? Log in</a>
        </p>
    </div>

    <script>
        // Password strength indicator
        document.addEventListener('DOMContentLoaded', function () {
            const password = document.getElementById('password');
            if (password) {
                const strength = document.getElementById('passwordStrength');
                const bar = document.getElementById('passwordStrengthBar');
                const hint = document.getElementById('passwordHint');

                password.addEventListener('input', function () {
                    const value = this.value;
                    const len = value.length;

                    if (len === 0) {
                        strength.classList.remove('visible');
                        bar.className = 'password-strength-bar';
                        hint.className = 'password-hint';
                        hint.textContent = 'At least 8 characters';
                        return;
                    }

                    strength.classList.add('visible');

                    // Calculate strength score
                    let score = 0;
                    if (len >= 8) score++;
                    if (len >= 12) score++;
                    if (/[a-z]/.test(value) && /[A-Z]/.test(value)) score++;
                    if (/\d/.test(value)) score++;
                    if (/[^a-zA-Z0-9]/.test(value)) score++;

                    // Update UI based on score
                    if (score <= 2) {
                        bar.className = 'password-strength-bar weak';
                        hint.className = 'password-hint weak-password';
                        hint.textContent = 'Weak password';
                    } else if (score <= 3) {
                        bar.className = 'password-strength-bar medium';
                        hint.className = 'password-hint medium-password';
                        hint.textContent = 'Medium strength';
                    } else {
                        bar.className = 'password-strength-bar strong';
                        hint.className = 'password-hint strong-password';
                        hint.textContent = 'Strong password!';
                    }
                });
            }
        });
    </script>
</body>

</html>