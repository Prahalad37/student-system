{% extends 'master.html' %}

{% block title %}Library{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb bg-transparent py-2 mb-0">
        <li class="breadcrumb-item"><a href="{% url 'index' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Library</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800 font-weight-bold"><i class="fas fa-book-reader text-primary mr-2"></i>Library Management</h1>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card shadow h-100">
            <div class="card-body">
                <h4 class="font-weight-bold text-primary">{{ total_books }}</h4>
                <p class="mb-0 text-muted">Total Books</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow h-100">
            <div class="card-body">
                <h4 class="font-weight-bold text-warning">{{ issued_books }}</h4>
                <p class="mb-0 text-muted">Books Issued</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow h-100">
            <div class="card-body">
                <h4 class="font-weight-bold"><a href="{% url 'export_library' %}" class="text-success">Download Report</a></h4>
                <p class="mb-0 text-muted">Export Excel</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Add New Book</h6>
            </div>
            <div class="card-body">
            <form action="{% url 'add_book' %}" method="POST">
                {% csrf_token %}
                <label for="id_lib_title">Book Title</label>
                <input type="text" name="title" id="id_lib_title" class="form-control mb-2" placeholder="Book Title" required>
                <label for="id_lib_author">Author Name</label>
                <input type="text" name="author" id="id_lib_author" class="form-control mb-2" placeholder="Author Name" required>
                <label for="id_lib_isbn">ISBN (Optional)</label>
                <input type="text" name="isbn" id="id_lib_isbn" class="form-control mb-2" placeholder="ISBN (Optional)">
                <label for="id_lib_copies">Total Copies</label>
                <input type="number" name="copies" id="id_lib_copies" class="form-control mb-2" placeholder="Total Copies" required>
                <button type="submit" class="btn btn-primary w-100">Add Book</button>
            </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Issue Book</h6>
            </div>
            <div class="card-body">
            <form action="{% url 'issue_book' %}" method="POST">
                {% csrf_token %}
                <label for="id_issue_student">Student</label>
                <select name="student_id" id="id_issue_student" class="form-control mb-2" required>
                    <option value="">Select Student</option>
                    {% for student in all_students %}
                    <option value="{{ student.id }}">{{ student.firstname }} {{ student.lastname }} ({{ student.student_class }})</option>
                    {% endfor %}
                </select>
                <label for="id_issue_book">Book</label>
                <select name="book_id" id="id_issue_book" class="form-control mb-2" required>
                    <option value="">Select Book</option>
                    {% for book in books %}
                    <option value="{{ book.id }}">{{ book.title }} ({{ book.available_copies }} left)</option>
                    {% endfor %}
                </select>
                <label for="id_issue_due_date">Due Date</label>
                <input type="date" name="due_date" id="id_issue_due_date" class="form-control mb-2" required>
                <button type="submit" class="btn btn-warning w-100">Issue Book</button>
            </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Currently Issued Books</h6>
            </div>
            <div class="card-body p-0">
            <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="pl-4">Student</th>
                        <th>Book</th>
                        <th>Issued Date</th>
                        <th>Due Date</th>
                        <th class="text-right pr-4">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transactions %}
                    <tr>
                        <td class="pl-4">{{ t.student.firstname }} {{ t.student.lastname }}</td>
                        <td>{{ t.book.title }}</td>
                        <td>{{ t.issue_date }}</td>
                        <td>{{ t.due_date }}</td>
                        <td class="text-right pr-4">
                            <a href="{% url 'return_book' t.id %}" class="btn btn-sm btn-success">Return</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">No books currently issued.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
            </div>
        </div>
        {% include "components/pagination.html" %}
    </div>
</div>
{% endblock %}