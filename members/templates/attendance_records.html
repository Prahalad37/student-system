{% extends "master.html" %}

{% block title %}Attendance History{% endblock %}

{% block content %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.11.5/datatables.min.css"/>

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center bg-white">
        <h6 class="m-0 font-weight-bold text-primary">Attendance Register üìã</h6>
        <a href="/attendance/" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm">
            <i class="fas fa-plus"></i> Mark New
        </a>
    </div>
    
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                <thead class="bg-light text-dark">
                    <tr>
                        <th style="width: 15%;">Date</th>
                        <th style="width: 30%;">Student Name</th>
                        <th>Fees Status üí∞</th>
                        <th>Attendance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for x in records %}
                    <tr>
                        <td>{{ x.date|date:"d M Y" }}</td> 
                        
                        <td class="font-weight-bold">
                            <a href="#" class="text-dark text-decoration-none"
                               data-toggle="popover" 
                               title="{{ x.student.firstname }}'s Profile"
                               data-content="
                                   <div class='text-center'>
                                       {% if x.student.profile_pic %}
                                           <img src='/media/{{ x.student.profile_pic }}' class='rounded-circle mb-2 shadow-sm' width='70' height='70' style='object-fit:cover;'>
                                       {% else %}
                                            <i class='fas fa-user-circle fa-4x text-gray-300 mb-2'></i>
                                       {% endif %}
                                       <h6 class='font-weight-bold text-primary'>{{ x.student.firstname }} {{ x.student.lastname }}</h6>
                                       <p class='small text-muted mb-2'>Class 12 - PCM</p>
                                       {% if x.student.due_amount > 0 %}
                                           <span class='badge badge-danger'>Due: ‚Çπ{{ x.student.due_amount }}</span>
                                       {% else %}
                                           <span class='badge badge-success'>Fees Paid ‚úÖ</span>
                                       {% endif %}
                                   </div>
                               ">
                               <img src="{% if x.student.profile_pic %}/media/{{ x.student.profile_pic }}{% else %}https://ui-avatars.com/api/?name={{ x.student.firstname }}{% endif %}" 
                                    class="rounded-circle mr-2" width="30" height="30">
                               {{ x.student.firstname }} {{ x.student.lastname }}
                            </a>
                        </td>

                        <td>
                            {% if x.student.due_amount > 0 %}
                                <span class="text-danger font-weight-bold" style="font-size: 0.9rem;">
                                    <i class="fas fa-exclamation-circle"></i> ‚Çπ{{ x.student.due_amount }} Due
                                </span>
                            {% else %}
                                <span class="text-success font-weight-bold" style="font-size: 0.9rem;">
                                    <i class="fas fa-check-circle"></i> Clear
                                </span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            {% if x.status == 'Present' %}
                                <span class="badge badge-success px-3 py-2 rounded-pill">Present</span>
                            {% elif x.status == 'Absent' %}
                                <span class="badge badge-danger px-3 py-2 rounded-pill">Absent</span>
                            {% else %}
                                <span class="badge badge-warning px-3 py-2 rounded-pill">Leave</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.11.5/datatables.min.js"></script>

<script>
    $(document).ready(function() {
        // 1. Initialize DataTable
        var table = $('#dataTable').DataTable({
            "order": [[ 0, "desc" ]], 
            "language": { "search": "üîç Filter Records:" },
            "drawCallback": function() {
                // Page change hone par Popover dobara initialize karo
                $('[data-toggle="popover"]').popover({
                    trigger: 'hover',
                    html: true,
                    placement: 'right'
                });
            }
        });

        // 2. Initialize Popover (First Time)
        $('[data-toggle="popover"]').popover({
            trigger: 'hover',
            html: true,
            placement: 'right'
        });
    });
</script>
{% endblock %}